{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/akash/Code/Projects/Notion-GPT%20Connector/app/api/read_page/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\n\nconst NOTION_TOKEN = process.env.NOTION_TOKEN!;\nconst NOTION_VERSION = process.env.NOTION_VERSION || \"2022-06-28\";\nconst INTERNAL_API_KEY = process.env.INTERNAL_API_KEY!;\n\nfunction requireKey(req: Request) {\n  if (req.headers.get(\"x-api-key\") !== INTERNAL_API_KEY) throw new Error(\"unauthorized\");\n}\n\nfunction extractPageId(input: string): string {\n  const m32 = input.match(/[0-9a-fA-F]{32}/);\n  const raw = (m32 ? m32[0] : input).replace(/-/g, \"\");\n  if (!/^[0-9a-fA-F]{32}$/.test(raw)) throw new Error(\"invalid_page_id\");\n  return raw.replace(/^(.{8})(.{4})(.{4})(.{4})(.{12})$/, \"$1-$2-$3-$4-$5\").toLowerCase();\n}\n\nasync function notionGET(path: string) {\n  const res = await fetch(`https://api.notion.com/v1${path}`, {\n    method: \"GET\",\n    headers: {\n      Authorization: `Bearer ${NOTION_TOKEN}`,\n      \"Notion-Version\": NOTION_VERSION\n    }\n  });\n  if (!res.ok) throw new Error(`notion_error_${res.status}`);\n  return res.json();\n}\n\nasync function listAllChildren(blockId: string) {\n  let results: any[] = [];\n  let cursor: string | null = null;\n  while (true) {\n    const qs = cursor ? `?start_cursor=${encodeURIComponent(cursor)}` : \"\";\n    const data = await notionGET(`/blocks/${blockId}/children${qs}`);\n    results = results.concat(data.results || []);\n    if (!data.has_more) break;\n    cursor = data.next_cursor;\n    if (!cursor) break;\n  }\n  return results;\n}\n\nfunction blocksToPlainText(blocks: any[]): string {\n  const lines: string[] = [];\n  for (const b of blocks) {\n    const t = b.type;\n    const obj = b[t];\n    const rich = obj?.rich_text;\n    const text = Array.isArray(rich)\n      ? rich.map((r: any) => r?.plain_text || \"\").join(\"\")\n      : \"\";\n    if (!text.trim()) continue;\n\n    if (t === \"heading_1\" || t === \"heading_2\" || t === \"heading_3\") lines.push(`\\n# ${text}`);\n    else if (t === \"bulleted_list_item\") lines.push(`- ${text}`);\n    else if (t === \"numbered_list_item\") lines.push(`1. ${text}`);\n    else lines.push(text);\n  }\n  return lines.join(\"\\n\").trim();\n}\n\nexport async function POST(req: Request) {\n  try {\n    requireKey(req);\n    const { page_url_or_id } = await req.json();\n    const pageId = extractPageId(String(page_url_or_id || \"\"));\n    const blocks = await listAllChildren(pageId);\n    return NextResponse.json({ page_id: pageId, text: blocksToPlainText(blocks) });\n  } catch (e: any) {\n    const msg = e?.message || \"error\";\n    return NextResponse.json({ error: msg }, { status: msg === \"unauthorized\" ? 401 : 400 });\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,eAAe,QAAQ,GAAG,CAAC,YAAY;AAC7C,MAAM,iBAAiB,QAAQ,GAAG,CAAC,cAAc,IAAI;AACrD,MAAM,mBAAmB,QAAQ,GAAG,CAAC,gBAAgB;AAErD,SAAS,WAAW,GAAY;IAC9B,IAAI,IAAI,OAAO,CAAC,GAAG,CAAC,iBAAiB,kBAAkB,MAAM,IAAI,MAAM;AACzE;AAEA,SAAS,cAAc,KAAa;IAClC,MAAM,MAAM,MAAM,KAAK,CAAC;IACxB,MAAM,MAAM,CAAC,MAAM,GAAG,CAAC,EAAE,GAAG,KAAK,EAAE,OAAO,CAAC,MAAM;IACjD,IAAI,CAAC,oBAAoB,IAAI,CAAC,MAAM,MAAM,IAAI,MAAM;IACpD,OAAO,IAAI,OAAO,CAAC,qCAAqC,kBAAkB,WAAW;AACvF;AAEA,eAAe,UAAU,IAAY;IACnC,MAAM,MAAM,MAAM,MAAM,CAAC,yBAAyB,EAAE,MAAM,EAAE;QAC1D,QAAQ;QACR,SAAS;YACP,eAAe,CAAC,OAAO,EAAE,cAAc;YACvC,kBAAkB;QACpB;IACF;IACA,IAAI,CAAC,IAAI,EAAE,EAAE,MAAM,IAAI,MAAM,CAAC,aAAa,EAAE,IAAI,MAAM,EAAE;IACzD,OAAO,IAAI,IAAI;AACjB;AAEA,eAAe,gBAAgB,OAAe;IAC5C,IAAI,UAAiB,EAAE;IACvB,IAAI,SAAwB;IAC5B,MAAO,KAAM;QACX,MAAM,KAAK,SAAS,CAAC,cAAc,EAAE,mBAAmB,SAAS,GAAG;QACpE,MAAM,OAAO,MAAM,UAAU,CAAC,QAAQ,EAAE,QAAQ,SAAS,EAAE,IAAI;QAC/D,UAAU,QAAQ,MAAM,CAAC,KAAK,OAAO,IAAI,EAAE;QAC3C,IAAI,CAAC,KAAK,QAAQ,EAAE;QACpB,SAAS,KAAK,WAAW;QACzB,IAAI,CAAC,QAAQ;IACf;IACA,OAAO;AACT;AAEA,SAAS,kBAAkB,MAAa;IACtC,MAAM,QAAkB,EAAE;IAC1B,KAAK,MAAM,KAAK,OAAQ;QACtB,MAAM,IAAI,EAAE,IAAI;QAChB,MAAM,MAAM,CAAC,CAAC,EAAE;QAChB,MAAM,OAAO,KAAK;QAClB,MAAM,OAAO,MAAM,OAAO,CAAC,QACvB,KAAK,GAAG,CAAC,CAAC,IAAW,GAAG,cAAc,IAAI,IAAI,CAAC,MAC/C;QACJ,IAAI,CAAC,KAAK,IAAI,IAAI;QAElB,IAAI,MAAM,eAAe,MAAM,eAAe,MAAM,aAAa,MAAM,IAAI,CAAC,CAAC,IAAI,EAAE,MAAM;aACpF,IAAI,MAAM,sBAAsB,MAAM,IAAI,CAAC,CAAC,EAAE,EAAE,MAAM;aACtD,IAAI,MAAM,sBAAsB,MAAM,IAAI,CAAC,CAAC,GAAG,EAAE,MAAM;aACvD,MAAM,IAAI,CAAC;IAClB;IACA,OAAO,MAAM,IAAI,CAAC,MAAM,IAAI;AAC9B;AAEO,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,WAAW;QACX,MAAM,EAAE,cAAc,EAAE,GAAG,MAAM,IAAI,IAAI;QACzC,MAAM,SAAS,cAAc,OAAO,kBAAkB;QACtD,MAAM,SAAS,MAAM,gBAAgB;QACrC,OAAO,gMAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAQ,MAAM,kBAAkB;QAAQ;IAC9E,EAAE,OAAO,GAAQ;QACf,MAAM,MAAM,GAAG,WAAW;QAC1B,OAAO,gMAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAI,GAAG;YAAE,QAAQ,QAAQ,iBAAiB,MAAM;QAAI;IACxF;AACF"}}]
}